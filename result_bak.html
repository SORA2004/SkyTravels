<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI ì—¬í–‰ ì¼ì •ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body { display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; background:#f0f8ff; font-family:'Helvetica Neue',sans-serif; text-align:center; }
    .progress-bar { width:80%; height:20px; background:#ddd; border-radius:10px; margin-top:20px; overflow:hidden; }
    .progress-fill { height:100%; width:0; background:#007bff; transition:width .3s; }
    .loading-message { font-size:1.2rem; margin-top:20px; color:#333; }
  </style>
</head>
<body>
  <h1>ì—¬í–‰ ì¼ì •ì„ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h1>
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  <div class="loading-message" id="loadingMessage">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!</div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const destination = params.get('destination');
    const startDate   = params.get('startDate');
    const endDate     = params.get('endDate');

    const progressFill   = document.getElementById('progressFill');
    const loadingMessage = document.getElementById('loadingMessage');

    const messages = [
      `${destination}ì˜ ë‚ ì”¨ë¥¼ ì¡°ì‚¬í•˜ëŠ” ì¤‘...`,
      `${destination}ì˜ ì¸ê¸° ëª…ì†Œë¥¼ ì°¾ëŠ” ì¤‘...`,
      `${destination}ì˜ ë§›ì§‘ì„ ì¡°ì‚¬í•˜ëŠ” ì¤‘...`,
      'ì¼ì •ì„ ìµœì í™”í•˜ëŠ” ì¤‘...',
      'ë§ˆì§€ë§‰ìœ¼ë¡œ ì¼ì • ì •ë¦¬ ì¤‘...'
    ];

    let percent = 0, messageIndex = 0;
    const progressInterval = setInterval(() => {
      percent = Math.min(percent + Math.floor(Math.random()*5 + 3), 100);
      progressFill.style.width = percent + '%';
      if (percent > (messageIndex+1)*20 && messageIndex < messages.length-1) {
        messageIndex++;
        loadingMessage.innerText = messages[messageIndex];
      }
    }, 300);

    async function fetchTravelPlan() {
      try {
        console.log('ğŸŒ ìš”ì²­:', { destination, startDate, endDate });
        // **ì—¬ê¸°ì— ì‹¤ì œë¡œ ë°°í¬ëœ í•¨ìˆ˜ URLì„ ë„£ìœ¼ì„¸ìš”!**
        const FUNCTION_URL = 'https://us-central1-skytravelai.cloudfunctions.net/createTravelPlan';
        
        const response = await fetch(FUNCTION_URL, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ destination, startDate, endDate })
        });
        console.log('ğŸ“¨ ì‘ë‹µ ìƒíƒœ:', response.status);

        const data = await response.json();
        console.log('ğŸ”¥ API ì‘ë‹µ data:', data);
        clearInterval(progressInterval);

        // data.result ëŠ” JSON ë¬¸ìì—´ì´ë¯€ë¡œ íŒŒì‹±
        const planObject = typeof data.result === 'string'
          ? JSON.parse(data.result)
          : data.result;
        console.log('ğŸ—’ï¸ planObject:', planObject);

        // ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
        const encoded = encodeURIComponent(JSON.stringify(planObject));
        console.log(encoded);
        //window.location.href = `result.html?plan=${encoded}`;

      } catch (err) {
        clearInterval(progressInterval);
        console.error('âŒ fetchTravelPlan ì—ëŸ¬:', err);
        alert('ì¼ì • ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }

    fetchTravelPlan();
  </script>
</body>
</html>
